name: Deploy Lambda to AWS (ZIP)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execu√ß√£o manual

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  PROJECT_NAME: ${{ secrets.PROJECT_NAME || 'autenticacao' }}

jobs:
  build-and-package:
    name: Build and Package .NET Lambda Functions
    runs-on: ubuntu-latest
    
    outputs:
      lambda_auth_zip: ${{ steps.package.outputs.lambda_auth_zip }}
      lambda_auth_admin_zip: ${{ steps.package.outputs.lambda_auth_admin_zip }}
      lambda_auth_migrator_zip: ${{ steps.package.outputs.lambda_auth_migrator_zip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Lambda (auth-lambda)
        run: |
          dotnet publish src/FastFood.Auth.Lambda/FastFood.Auth.Lambda.csproj \
            -c Release \
            -o publish/auth-lambda \
            --self-contained false

      - name: Build Lambda (auth-admin-lambda)
        run: |
          dotnet publish src/FastFood.Auth.Lambda/FastFood.Auth.Lambda.csproj \
            -c Release \
            -o publish/auth-admin-lambda \
            --self-contained false

      - name: Build Migrator Lambda (auth-migrator-lambda)
        run: |
          dotnet publish src/FastFood.Auth.Migrator/FastFood.Auth.Migrator.csproj \
            -c Release \
            -o publish/auth-migrator-lambda \
            --self-contained false

      - name: Create bootstrap script for auth-lambda
        run: |
          cat > publish/auth-lambda/bootstrap << 'EOF'
          #!/bin/sh
          set -euo pipefail
          exec /var/lang/bin/dotnet FastFood.Auth.Lambda.dll
          EOF
          chmod +x publish/auth-lambda/bootstrap

      - name: Create bootstrap script for auth-admin-lambda
        run: |
          cat > publish/auth-admin-lambda/bootstrap << 'EOF'
          #!/bin/sh
          set -euo pipefail
          exec /var/lang/bin/dotnet FastFood.Auth.Lambda.dll
          EOF
          chmod +x publish/auth-admin-lambda/bootstrap

      - name: Create bootstrap script for auth-migrator-lambda
        run: |
          cat > publish/auth-migrator-lambda/bootstrap << 'EOF'
          #!/bin/sh
          set -euo pipefail
          exec /var/lang/bin/dotnet FastFood.Auth.Migrator.dll
          EOF
          chmod +x publish/auth-migrator-lambda/bootstrap

      - name: Package Lambda functions
        id: package
        run: |
          cd publish/auth-lambda
          zip -r ../../lambda-auth.zip . -q
          echo "lambda_auth_zip=lambda-auth.zip" >> $GITHUB_OUTPUT
          
          cd ../auth-admin-lambda
          zip -r ../../lambda-auth-admin.zip . -q
          echo "lambda_auth_admin_zip=lambda-auth-admin.zip" >> $GITHUB_OUTPUT
          
          cd ../auth-migrator-lambda
          zip -r ../../lambda-auth-migrator.zip . -q
          echo "lambda_auth_migrator_zip=lambda-auth-migrator.zip" >> $GITHUB_OUTPUT
          
          cd ../..
          ls -lh *.zip

      - name: Upload ZIP artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-zips
          path: |
            lambda-auth.zip
            lambda-auth-admin.zip
            lambda-auth-migrator.zip
          retention-days: 1

  deploy-lambdas:
    name: Deploy Lambda Functions
    needs: build-and-package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lambda:
          - name: auth-lambda
            zip_file: lambda-auth.zip
            function_name: ${{ env.PROJECT_NAME }}-auth-lambda
          - name: auth-admin-lambda
            zip_file: lambda-auth-admin.zip
            function_name: ${{ env.PROJECT_NAME }}-auth-admin-lambda
          - name: auth-migrator-lambda
            zip_file: lambda-auth-migrator.zip
            function_name: ${{ env.PROJECT_NAME }}-auth-migrator-lambda
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ff717079ee2060e4bcee96c4779b553acc87447c # v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download ZIP artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-zips
          path: .

      - name: Verify Lambda exists
        env:
          LAMBDA_FUNCTION_NAME: ${{ matrix.lambda.function_name }}
        run: |
          echo "üîç Verificando Lambda antes de atualizar c√≥digo..."
          echo "  - Lambda Function Name: ${LAMBDA_FUNCTION_NAME}"
          
          # Verifica se o Lambda existe na AWS
          if ! aws lambda get-function \
            --function-name "${LAMBDA_FUNCTION_NAME}" \
            --region "${AWS_REGION}" > /dev/null 2>&1; then
            echo "‚ùå ERRO CR√çTICO: Lambda '${LAMBDA_FUNCTION_NAME}' N√ÉO existe na AWS!"
            echo "   O Lambda deve ser criado via Terraform antes de atualizar o c√≥digo"
            echo "   Execute: terraform apply no diret√≥rio terraform/"
            exit 1
          fi
          
          # Obt√©m informa√ß√µes do Lambda
          LAMBDA_INFO=$(aws lambda get-function \
            --function-name "${LAMBDA_FUNCTION_NAME}" \
            --region "${AWS_REGION}" \
            --output json 2>/dev/null)
          
          PACKAGE_TYPE=$(echo "${LAMBDA_INFO}" | jq -r '.Configuration.PackageType // "unknown"')
          
          if [ "${PACKAGE_TYPE}" != "Zip" ]; then
            echo "‚ùå ERRO CR√çTICO: Lambda n√£o √© do tipo Zip!"
            echo "   PackageType atual: ${PACKAGE_TYPE}"
            echo "   Este workflow espera que o Lambda seja do tipo 'Zip'"
            echo "   Execute: terraform apply no diret√≥rio terraform/ para corrigir"
            exit 1
          fi
          
          echo "‚úÖ Lambda encontrado e √© do tipo Zip - pronto para atualiza√ß√£o"

      - name: Update Lambda function code
        env:
          LAMBDA_FUNCTION_NAME: ${{ matrix.lambda.function_name }}
          ZIP_FILE: ${{ matrix.lambda.zip_file }}
        run: |
          echo "üîÑ Atualizando c√≥digo do Lambda..."
          echo "  - Lambda Function Name: ${LAMBDA_FUNCTION_NAME}"
          echo "  - ZIP File: ${ZIP_FILE}"
          
          # Verifica se o arquivo ZIP existe
          if [ ! -f "${ZIP_FILE}" ]; then
            echo "‚ùå Erro: Arquivo ZIP n√£o encontrado: ${ZIP_FILE}"
            exit 1
          fi
          
          # Atualiza o c√≥digo do Lambda usando AWS CLI
          echo ""
          echo "üìã Executando: aws lambda update-function-code --zip-file"
          echo ""
          
          UPDATE_OUTPUT=$(aws lambda update-function-code \
            --function-name "${LAMBDA_FUNCTION_NAME}" \
            --zip-file "fileb://${ZIP_FILE}" \
            --region "${AWS_REGION}" \
            --output json 2>&1)
          UPDATE_EXIT_CODE=$?
          
          if [ ${UPDATE_EXIT_CODE} -eq 0 ]; then
            echo "‚úÖ C√≥digo do Lambda atualizado com sucesso!"
            echo ""
            echo "üìä Informa√ß√µes da atualiza√ß√£o:"
            echo "${UPDATE_OUTPUT}" | jq -r '. | "  - Function Name: \(.FunctionName)\n  - Last Update Status: \(.LastUpdateStatus)\n  - State: \(.State)\n  - Code Size: \(.CodeSize) bytes"' || echo "${UPDATE_OUTPUT}"
            
            # Aguarda a atualiza√ß√£o completar
            echo ""
            echo "‚è≥ Aguardando atualiza√ß√£o completar..."
            aws lambda wait function-updated \
              --function-name "${LAMBDA_FUNCTION_NAME}" \
              --region "${AWS_REGION}" || true
            
            echo "‚úÖ Lambda atualizado e pronto para uso"
          else
            echo "‚ùå Erro ao atualizar c√≥digo do Lambda (exit code: ${UPDATE_EXIT_CODE})"
            echo ""
            echo "üìã Mensagem de erro do AWS CLI:"
            echo "${UPDATE_OUTPUT}"
            exit 1
          fi

      - name: Verify Lambda update
        env:
          LAMBDA_FUNCTION_NAME: ${{ matrix.lambda.function_name }}
        run: |
          echo "üîç Verificando informa√ß√µes finais do Lambda ap√≥s atualiza√ß√£o..."
          echo ""
          
          LAMBDA_INFO=$(aws lambda get-function \
            --function-name "${LAMBDA_FUNCTION_NAME}" \
            --region "${AWS_REGION}" \
            --output json 2>/dev/null)
          
          if [ -n "${LAMBDA_INFO}" ]; then
            echo "üìä Informa√ß√µes do Lambda na AWS:"
            echo "${LAMBDA_INFO}" | jq -r '.Configuration | "  - Function Name: \(.FunctionName)\n  - Function ARN: \(.FunctionArn)\n  - Last Modified: \(.LastModified)\n  - State: \(.State)\n  - Package Type: \(.PackageType)\n  - Code Size: \(.CodeSize) bytes"'
            echo ""
            echo "‚úÖ Lambda atualizado com sucesso!"
          else
            echo "‚ö†Ô∏è N√£o foi poss√≠vel obter informa√ß√µes do Lambda"
          fi
