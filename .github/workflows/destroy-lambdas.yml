name: Destroy Lambda Infrastructure

on:
  workflow_dispatch: # Apenas execuÃ§Ã£o manual
    inputs:
      confirm_destroy:
        description: 'Digite "DESTROY" para confirmar a destruiÃ§Ã£o'
        required: true
        type: string

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID || '058264347413' }}

jobs:
  destroy-infrastructure:
    name: Destroy Lambda Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ ConfirmaÃ§Ã£o invÃ¡lida!"
            echo "   VocÃª deve digitar 'DESTROY' para confirmar a destruiÃ§Ã£o."
            exit 1
          fi
          echo "âœ… ConfirmaÃ§Ã£o vÃ¡lida. Prosseguindo com a destruiÃ§Ã£o..."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set project name
        id: project-name
        run: |
          PROJECT_NAME="${{ secrets.PROJECT_NAME }}"
          if [ -z "${PROJECT_NAME}" ]; then
            PROJECT_NAME="autenticacao"
          fi
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "Using project name: ${PROJECT_NAME}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: List resources to be destroyed
        working-directory: terraform
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_project_name: ${{ steps.project-name.outputs.project_name }}
          TF_VAR_env: ${{ secrets.ENV || 'dev' }}
          TF_VAR_lab_role: ${{ secrets.LAB_ROLE }}
          TF_VAR_cognito_region: ${{ secrets.COGNITO_REGION }}
          TF_VAR_cognito_user_pool_id: ${{ secrets.COGNITO_USER_POOL_ID }}
          TF_VAR_cognito_client_id: ${{ secrets.COGNITO_CLIENT_ID }}
          TF_VAR_rds_connection_string: ${{ secrets.RDS_CONNECTION_STRING }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_issuer: ${{ secrets.JWT_ISSUER }}
          TF_VAR_jwt_audience: ${{ secrets.JWT_AUDIENCE }}
        run: |
          echo "ğŸ” Listando recursos que serÃ£o destruÃ­dos..."
          terraform plan -destroy -out=tfplan
          echo ""
          echo "âš ï¸  ATENÃ‡ÃƒO: Os seguintes recursos serÃ£o DESTRUÃDOS:"
          echo "   - Lambda Functions (auth-customer-lambda, auth-admin-lambda, auth-migrator-lambda)"
          echo "   - Function URLs"
          echo "   - Security Groups"
          echo "   - ECR Repository (opcional, se configurado)"

      - name: Terraform Destroy
        working-directory: terraform
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_project_name: ${{ steps.project-name.outputs.project_name }}
          TF_VAR_env: ${{ secrets.ENV || 'dev' }}
          TF_VAR_lab_role: ${{ secrets.LAB_ROLE }}
          TF_VAR_cognito_region: ${{ secrets.COGNITO_REGION }}
          TF_VAR_cognito_user_pool_id: ${{ secrets.COGNITO_USER_POOL_ID }}
          TF_VAR_cognito_client_id: ${{ secrets.COGNITO_CLIENT_ID }}
          TF_VAR_rds_connection_string: ${{ secrets.RDS_CONNECTION_STRING }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_issuer: ${{ secrets.JWT_ISSUER }}
          TF_VAR_jwt_audience: ${{ secrets.JWT_AUDIENCE }}
        run: |
          echo "ğŸ—‘ï¸  Executando terraform destroy..."
          terraform destroy -auto-approve
          echo ""
          echo "âœ… Infraestrutura destruÃ­da com sucesso!"

      - name: Delete ECR Images (Optional)
        continue-on-error: true
        run: |
          echo "ğŸ—‘ï¸  Removendo imagens do ECR (se existirem)..."
          
          REPO_NAME="fiap-fase4-auth-lambda"
          
          # Verificar se o repositÃ³rio existe
          if aws ecr describe-repositories --repository-names "${REPO_NAME}" --region "${AWS_REGION}" > /dev/null 2>&1; then
            echo "   RepositÃ³rio encontrado: ${REPO_NAME}"
            
            # Listar todas as imagens
            IMAGES=$(aws ecr list-images \
              --repository-name "${REPO_NAME}" \
              --region "${AWS_REGION}" \
              --query 'imageIds[*]' \
              --output json)
            
            if [ "$(echo ${IMAGES} | jq 'length')" -gt 0 ]; then
              echo "   Removendo ${IMAGES} imagens..."
              
              # Deletar todas as imagens
              echo "${IMAGES}" | jq -c '.[]' | while read image; do
                aws ecr batch-delete-image \
                  --repository-name "${REPO_NAME}" \
                  --region "${AWS_REGION}" \
                  --image-ids "${image}" || true
              done
              
              echo "   âœ… Imagens removidas do ECR"
            else
              echo "   â„¹ï¸  Nenhuma imagem encontrada no repositÃ³rio"
            fi
          else
            echo "   â„¹ï¸  RepositÃ³rio ECR nÃ£o existe ou jÃ¡ foi removido"
          fi

      - name: Verify destruction
        run: |
          echo ""
          echo "ğŸ” Verificando se os Lambdas foram removidos..."
          
          LAMBDA_NAMES=(
            "${{ steps.project-name.outputs.project_name }}-auth-customer-lambda"
            "${{ steps.project-name.outputs.project_name }}-auth-admin-lambda"
            "${{ steps.project-name.outputs.project_name }}-auth-migrator-lambda"
          )
          
          ALL_REMOVED=true
          for LAMBDA_NAME in "${LAMBDA_NAMES[@]}"; do
            if aws lambda get-function \
              --function-name "${LAMBDA_NAME}" \
              --region "${AWS_REGION}" > /dev/null 2>&1; then
              echo "   âš ï¸  Lambda ainda existe: ${LAMBDA_NAME}"
              ALL_REMOVED=false
            else
              echo "   âœ… Lambda removido: ${LAMBDA_NAME}"
            fi
          done
          
          if [ "${ALL_REMOVED}" = true ]; then
            echo ""
            echo "âœ… Todos os Lambdas foram removidos com sucesso!"
          else
            echo ""
            echo "âš ï¸  Alguns Lambdas ainda existem. Verifique manualmente."
          fi

      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ RESUMO DA DESTRUIÃ‡ÃƒO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Infraestrutura destruÃ­da:"
          echo "   - Lambda Functions"
          echo "   - Function URLs"
          echo "   - Security Groups"
          echo "   - ECR Images (se existiam)"
          echo ""
          echo "âš ï¸  ATENÃ‡ÃƒO:"
          echo "   - Os dados do banco de dados NÃƒO foram removidos"
          echo "   - O repositÃ³rio ECR pode ainda existir (depende da configuraÃ§Ã£o)"
          echo "   - Para recriar, execute a action 'Deploy Lambda Functions to AWS'"
          echo ""

